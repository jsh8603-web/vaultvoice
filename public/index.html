<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="VaultVoice">
<meta name="theme-color" content="#007AFF">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<title>VaultVoice</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --blue: #007AFF; --red: #FF3B30; --green: #34C759;
  --bg: #F2F2F7; --bg-card: #FFFFFF; --bg-input: #FFFFFF;
  --text: #000000; --text2: #8E8E93; --sep: rgba(60,60,67,0.12);
  --tabbar: rgba(249,249,249,0.94); --radius: 12px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #000; --bg-card: #1C1C1E; --bg-input: #2C2C2E;
    --text: #FFF; --text2: #98989D; --sep: rgba(84,84,88,0.36);
    --tabbar: rgba(28,28,30,0.94);
  }
}
html, body {
  height: 100%; font-family: -apple-system, system-ui, sans-serif;
  background: var(--bg); color: var(--text);
  -webkit-font-smoothing: antialiased; overscroll-behavior: none;
}
.screen { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: var(--bg); z-index: 100; }
.auth-box { text-align: center; padding: 24px; width: 100%; max-width: 320px; }
.auth-box h1 { font-size: 28px; margin: 8px 0 4px; }
.auth-box p { color: var(--text2); margin-bottom: 20px; font-size: 15px; }
.err { color: var(--red); font-size: 13px; margin-top: 12px; }

header { position: fixed; top: 0; left: 0; right: 0; z-index: 50; display: flex; align-items: center; justify-content: center; padding: calc(var(--safe-top) + 8px) 16px 8px; background: var(--tabbar); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 0.5px solid var(--sep); }
header h1 { font-size: 17px; font-weight: 600; }

main { padding-top: calc(var(--safe-top) + 52px); padding-bottom: calc(var(--safe-bottom) + 68px); min-height: 100vh; }
.tab-panel { display: none; padding: 12px 16px; }
.tab-panel.active { display: block; }

nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; display: flex; padding-bottom: var(--safe-bottom); background: var(--tabbar); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 0.5px solid var(--sep); }
.tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 6px 0 4px; background: none; border: none; color: var(--text2); font-size: 10px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
.tab-item.active { color: var(--blue); }
.tab-icon { font-size: 22px; line-height: 1; margin-bottom: 1px; }

.input { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--sep); border-radius: var(--radius); color: var(--text); font-size: 16px; font-family: inherit; outline: none; -webkit-appearance: none; }
.input:focus { border-color: var(--blue); }
textarea.input { resize: vertical; min-height: 140px; line-height: 1.5; }

.btn { width: 100%; padding: 14px; background: var(--blue); color: #fff; border: none; border-radius: var(--radius); font-size: 17px; font-weight: 600; font-family: inherit; cursor: pointer; -webkit-tap-highlight-color: transparent; }
.btn:active { transform: scale(0.97); opacity: 0.9; }
.btn:disabled { opacity: 0.5; }
.btn-save { margin-top: 8px; padding: 16px; font-size: 18px; }
.btn-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--bg-card); border: 1px solid var(--sep); border-radius: 50%; font-size: 20px; color: var(--text); cursor: pointer; }
.btn-sm { padding: 8px 14px; background: var(--blue); color: #fff; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
.btn-danger { width: 100%; padding: 14px; background: none; color: var(--red); border: 1px solid var(--red); border-radius: var(--radius); font-size: 16px; cursor: pointer; }

.date-nav { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 16px; }
.date-btn { padding: 6px 16px; background: var(--bg-card); border: 1px solid var(--sep); border-radius: 20px; font-size: 15px; font-weight: 500; color: var(--text); cursor: pointer; min-width: 140px; text-align: center; }

.form-group { margin-bottom: 16px; }
.form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--text2); text-transform: uppercase; margin-bottom: 6px; padding-left: 4px; }

.chips { display: flex; gap: 8px; flex-wrap: wrap; }
.chip { padding: 8px 14px; background: var(--bg-card); border: 1px solid var(--sep); border-radius: 20px; font-size: 14px; color: var(--text); cursor: pointer; -webkit-tap-highlight-color: transparent; }
.chip.on { background: var(--blue); color: #fff; border-color: var(--blue); }

.tag-list { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
.tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: rgba(0,122,255,0.12); color: var(--blue); border-radius: 12px; font-size: 13px; }
.tag-x { cursor: pointer; font-size: 15px; opacity: 0.7; }
.suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--sep); border-radius: var(--radius); max-height: 150px; overflow-y: auto; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.sug-item { padding: 10px 14px; font-size: 14px; cursor: pointer; border-bottom: 0.5px solid var(--sep); }

.feedback { text-align: center; padding: 12px; margin-top: 8px; border-radius: var(--radius); font-size: 15px; font-weight: 500; }
.feedback.ok { background: rgba(52,199,89,0.12); color: var(--green); }
.feedback.fail { background: rgba(255,59,48,0.12); color: var(--red); }

.note-content { background: var(--bg-card); border-radius: var(--radius); padding: 16px; line-height: 1.6; font-size: 15px; word-break: break-word; }
.note-content h1 { font-size: 22px; margin-bottom: 12px; }
.note-content h2 { font-size: 18px; font-weight: 600; margin-top: 16px; margin-bottom: 8px; color: var(--blue); }
.note-content li { margin-bottom: 4px; }
.empty { text-align: center; color: var(--text2); padding: 40px 20px; font-size: 15px; }

.hist-item { background: var(--bg-card); border-radius: var(--radius); padding: 14px; margin-bottom: 8px; cursor: pointer; }
.hist-item:active { transform: scale(0.98); }
.hist-date { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.hist-preview { color: var(--text2); font-size: 13px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.overlay { position: fixed; inset: 0; background: var(--bg); z-index: 60; padding: calc(var(--safe-top) + 16px) 16px calc(var(--safe-bottom) + 16px); overflow-y: auto; }
.close-btn { position: absolute; top: calc(var(--safe-top) + 8px); right: 12px; font-size: 28px; background: none; border: none; color: var(--text); cursor: pointer; z-index: 61; }

.s-group { background: var(--bg-card); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; }
.s-group h2 { font-size: 13px; font-weight: 600; text-transform: uppercase; color: var(--text2); margin-bottom: 12px; }
.s-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 6px 0; }
.s-val { font-size: 13px; color: var(--text2); text-align: right; word-break: break-all; max-width: 200px; }
.badge { padding: 3px 10px; border-radius: 10px; font-size: 12px; font-weight: 600; }
.badge.ok { background: rgba(52,199,89,0.15); color: var(--green); }
.badge.err { background: rgba(255,59,48,0.15); color: var(--red); }
.ver { text-align: center; color: var(--text2); font-size: 12px; margin-top: 24px; }
</style>
</head>
<body>

<!-- Auth -->
<div id="auth" class="screen">
  <div class="auth-box">
    <div style="font-size:48px">üîê</div>
    <h1>VaultVoice</h1>
    <p>API ÌÇ§Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
    <input type="text" id="key-input" class="input" placeholder="API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <br><br>
    <button class="btn" onclick="doAuth()">Ïó∞Í≤∞</button>
    <p id="auth-err" class="err" style="display:none"></p>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  <header><h1 id="hdr">Î©îÎ™®</h1></header>
  <main>
    <!-- Î©îÎ™® -->
    <section id="p-memo" class="tab-panel active">
      <div class="date-nav">
        <button class="btn-icon" onclick="shiftMemoDate(-1)">&lsaquo;</button>
        <button id="memo-date" class="date-btn" onclick="resetMemoDate()">Ïò§Îäò</button>
        <button class="btn-icon" onclick="shiftMemoDate(1)">&rsaquo;</button>
      </div>
      <div class="form-group">
        <label>ÏÑπÏÖò</label>
        <div class="chips" id="sec-chips">
          <button class="chip on" onclick="pickSec(this)" data-s="Î©îÎ™®">Î©îÎ™®</button>
          <button class="chip" onclick="pickSec(this)" data-s="Ïò§ÎäòÌï†Ïùº">Ïò§ÎäòÌï†Ïùº</button>
          <button class="chip" onclick="pickSec(this)" data-s="Ïò§Îäò ÌöåÍ≥†">Ïò§Îäò ÌöåÍ≥†</button>
        </div>
      </div>
      <div class="form-group">
        <label>ÎÇ¥Ïö©</label>
        <textarea id="memo-text" class="input" placeholder="Ïó¨Í∏∞Î•º ÌÉ≠ÌïòÍ≥† ÌÇ§Î≥¥Îìú üéôÔ∏è Î≤ÑÌäºÏúºÎ°ú ÏùåÏÑ± ÏûÖÎ†•..." rows="6"></textarea>
      </div>
      <div class="form-group">
        <label>ÌÉúÍ∑∏</label>
        <div id="tags-display" class="tag-list"></div>
        <div style="position:relative">
          <input type="text" id="tag-in" class="input" placeholder="ÌÉúÍ∑∏ Ï∂îÍ∞Ä (Enter)" autocomplete="off" autocorrect="off" autocapitalize="off">
          <div id="tag-sug" class="suggestions" style="display:none"></div>
        </div>
      </div>
      <button class="btn btn-save" onclick="doSave()">Ï†ÄÏû•</button>
      <div id="save-fb" class="feedback" style="display:none"></div>
    </section>

    <!-- Ïò§Îäò -->
    <section id="p-today" class="tab-panel">
      <div class="date-nav">
        <button class="btn-icon" onclick="shiftTodayDate(-1)">&lsaquo;</button>
        <button id="today-date" class="date-btn" onclick="resetTodayDate()">Ïò§Îäò</button>
        <button class="btn-icon" onclick="shiftTodayDate(1)">&rsaquo;</button>
      </div>
      <div id="today-body" class="note-content"><div class="empty">Î°úÎî© Ï§ë...</div></div>
    </section>

    <!-- Í∏∞Î°ù -->
    <section id="p-hist" class="tab-panel">
      <input type="search" id="hist-search" class="input" placeholder="Í≤ÄÏÉâ..." oninput="filterHist()" style="margin-bottom:12px">
      <div id="hist-list"><div class="empty">Î°úÎî© Ï§ë...</div></div>
      <div id="hist-overlay" class="overlay" style="display:none">
        <button class="close-btn" onclick="closePreview()">&times;</button>
        <div id="hist-detail" class="note-content"></div>
      </div>
    </section>

    <!-- ÏÑ§Ï†ï -->
    <section id="p-set" class="tab-panel">
      <div class="s-group">
        <h2>ÏÑúÎ≤Ñ Ïó∞Í≤∞</h2>
        <div class="s-row"><span>ÏÉÅÌÉú</span><span id="st-conn" class="badge">ÌôïÏù∏Ï§ë</span></div>
        <div class="s-row" style="border-top:0.5px solid var(--sep);padding-top:10px;margin-top:4px"><span>Î≥ºÌä∏</span><span id="st-vault" class="s-val">-</span></div>
      </div>
      <div class="s-group">
        <h2>Í∏∞Î≥∏ ÏÑπÏÖò</h2>
        <select id="def-sec" class="input" onchange="localStorage.setItem('vv_sec',this.value)">
          <option value="Î©îÎ™®">Î©îÎ™®</option>
          <option value="Ïò§ÎäòÌï†Ïùº">Ïò§ÎäòÌï†Ïùº</option>
          <option value="Ïò§Îäò ÌöåÍ≥†">Ïò§Îäò ÌöåÍ≥†</option>
        </select>
      </div>
      <div class="s-group">
        <button class="btn-danger" onclick="doLogout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
      </div>
      <div class="ver">VaultVoice v1.0</div>
    </section>
  </main>

  <nav>
    <button class="tab-item active" onclick="switchTab('memo',this)"><span class="tab-icon">&#9998;</span><span>Î©îÎ™®</span></button>
    <button class="tab-item" onclick="switchTab('today',this)"><span class="tab-icon">&#128203;</span><span>Ïò§Îäò</span></button>
    <button class="tab-item" onclick="switchTab('hist',this)"><span class="tab-icon">&#128218;</span><span>Í∏∞Î°ù</span></button>
    <button class="tab-item" onclick="switchTab('set',this)"><span class="tab-icon">&#9881;</span><span>ÏÑ§Ï†ï</span></button>
  </nav>
</div>

<script>
// ---- State ----
var API_KEY = localStorage.getItem('vv_apiKey') || '';
var memoDate = new Date();
var todayViewDate = new Date();
var curSection = localStorage.getItem('vv_sec') || 'Î©îÎ™®';
var myTags = [];
var allTags = [];

// ---- URL key param auto-login ----
(function() {
  var p = new URLSearchParams(location.search);
  var k = p.get('key');
  if (k) {
    localStorage.setItem('vv_apiKey', k);
    API_KEY = k;
    history.replaceState(null, '', '/');
  }
})();

// ---- Auth ----
function doAuth() {
  var input = document.getElementById('key-input');
  var err = document.getElementById('auth-err');
  var key = input.value.trim();
  if (!key) { err.textContent = 'ÌÇ§Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî'; err.style.display = ''; return; }
  err.style.display = 'none';
  fetch('/api/tags', { headers: { 'Authorization': 'Bearer ' + key } })
    .then(function(r) {
      if (r.ok) {
        localStorage.setItem('vv_apiKey', key);
        API_KEY = key;
        showApp();
      } else {
        err.textContent = 'ÌÇ§ Ïò§Î•ò (' + r.status + ')';
        err.style.display = '';
      }
    })
    .catch(function(e) {
      err.textContent = 'Ïó∞Í≤∞ Ïã§Ìå®: ' + e.message;
      err.style.display = '';
    });
}

function doLogout() {
  localStorage.removeItem('vv_apiKey');
  API_KEY = '';
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth').style.display = '';
}

function showApp() {
  document.getElementById('auth').style.display = 'none';
  document.getElementById('app').style.display = '';
  updateMemoDate();
  updateTodayDate();
  loadTags();
}

// ---- API helper ----
function api(path, opts) {
  opts = opts || {};
  opts.headers = opts.headers || {};
  opts.headers['Authorization'] = 'Bearer ' + API_KEY;
  opts.headers['Content-Type'] = 'application/json';
  return fetch('/api' + path, opts);
}

// ---- Tabs ----
function switchTab(name, btn) {
  var titles = { memo: 'Î©îÎ™®', today: 'Ïò§Îäò', hist: 'Í∏∞Î°ù', set: 'ÏÑ§Ï†ï' };
  document.getElementById('hdr').textContent = titles[name] || '';
  var panels = document.querySelectorAll('.tab-panel');
  var tabs = document.querySelectorAll('.tab-item');
  for (var i = 0; i < panels.length; i++) panels[i].className = 'tab-panel';
  for (var i = 0; i < tabs.length; i++) tabs[i].className = 'tab-item';
  document.getElementById('p-' + name).className = 'tab-panel active';
  btn.className = 'tab-item active';
  if (name === 'today') loadToday();
  if (name === 'hist') loadHistory();
  if (name === 'set') loadSettings();
}

// ---- Date helpers ----
function fmt(d) { return d.toISOString().slice(0, 10); }
function fmtDisplay(d) {
  var days = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
  var t = new Date(); var m = d.getMonth()+1; var day = d.getDate();
  if (fmt(d) === fmt(t)) return 'Ïò§Îäò (' + m + '/' + day + ' ' + days[d.getDay()] + ')';
  return m + '/' + day + ' (' + days[d.getDay()] + ')';
}

// ---- Memo tab ----
function updateMemoDate() { document.getElementById('memo-date').textContent = fmtDisplay(memoDate); }
function shiftMemoDate(n) { memoDate.setDate(memoDate.getDate() + n); updateMemoDate(); }
function resetMemoDate() { memoDate = new Date(); updateMemoDate(); }

function pickSec(el) {
  var chips = document.querySelectorAll('#sec-chips .chip');
  for (var i = 0; i < chips.length; i++) chips[i].className = 'chip';
  el.className = 'chip on';
  curSection = el.getAttribute('data-s');
}

function addTag(t) {
  t = t.trim();
  if (!t || myTags.indexOf(t) >= 0) return;
  myTags.push(t);
  renderTags();
}
function removeTag(t) {
  myTags = myTags.filter(function(x) { return x !== t; });
  renderTags();
}
function renderTags() {
  var el = document.getElementById('tags-display');
  el.innerHTML = myTags.map(function(t) {
    return '<span class="tag">' + esc(t) + '<span class="tag-x" onclick="removeTag(\'' + esc(t) + '\')">&times;</span></span>';
  }).join('');
}

// Tag input
document.addEventListener('DOMContentLoaded', function() {
  var tagIn = document.getElementById('tag-in');
  var tagSug = document.getElementById('tag-sug');
  if (!tagIn) return;
  tagIn.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); addTag(tagIn.value); tagIn.value = ''; tagSug.style.display = 'none'; }
  });
  tagIn.addEventListener('input', function() {
    var q = tagIn.value.trim().toLowerCase();
    if (!q) { tagSug.style.display = 'none'; return; }
    var m = allTags.filter(function(t) { return t.tag.toLowerCase().indexOf(q) >= 0 && myTags.indexOf(t.tag) < 0; }).slice(0, 5);
    if (!m.length) { tagSug.style.display = 'none'; return; }
    tagSug.innerHTML = m.map(function(t) { return '<div class="sug-item" onclick="addTag(\'' + esc(t.tag) + '\');document.getElementById(\'tag-in\').value=\'\';document.getElementById(\'tag-sug\').style.display=\'none\'">' + esc(t.tag) + ' (' + t.count + ')</div>'; }).join('');
    tagSug.style.display = '';
  });
});

function loadTags() {
  api('/tags').then(function(r) { return r.json(); }).then(function(d) { allTags = d.tags || []; }).catch(function() {});
}

function doSave() {
  var text = document.getElementById('memo-text').value.trim();
  var fb = document.getElementById('save-fb');
  if (!text) { document.getElementById('memo-text').focus(); return; }
  api('/daily/' + fmt(memoDate), {
    method: 'POST',
    body: JSON.stringify({ content: text, tags: myTags, section: curSection })
  }).then(function(r) {
    if (r.ok) {
      fb.textContent = 'Ï†ÄÏû• ÏôÑÎ£å!';
      fb.className = 'feedback ok';
      fb.style.display = '';
      document.getElementById('memo-text').value = '';
      myTags = []; renderTags();
      if (navigator.vibrate) navigator.vibrate(50);
    } else {
      r.json().then(function(d) { fb.textContent = 'Ïã§Ìå®: ' + (d.error||r.status); fb.className = 'feedback fail'; fb.style.display = ''; });
    }
  }).catch(function(e) {
    fb.textContent = 'Ïã§Ìå®: ' + e.message; fb.className = 'feedback fail'; fb.style.display = '';
  });
  setTimeout(function() { fb.style.display = 'none'; }, 3000);
}

// ---- Today tab ----
function updateTodayDate() { document.getElementById('today-date').textContent = fmtDisplay(todayViewDate); }
function shiftTodayDate(n) { todayViewDate.setDate(todayViewDate.getDate() + n); updateTodayDate(); loadToday(); }
function resetTodayDate() { todayViewDate = new Date(); updateTodayDate(); loadToday(); }

function loadToday() {
  var el = document.getElementById('today-body');
  api('/daily/' + fmt(todayViewDate))
    .then(function(r) {
      if (r.status === 404) { el.innerHTML = '<div class="empty">Ïù¥ ÎÇ† ÏùºÏùºÎÖ∏Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§</div>'; return; }
      return r.json().then(function(d) { el.innerHTML = renderMd(d.body); });
    })
    .catch(function(e) { el.innerHTML = '<div class="empty">Ïò§Î•ò: ' + e.message + '</div>'; });
}

// ---- History tab ----
function loadHistory() {
  var el = document.getElementById('hist-list');
  api('/notes/recent')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      if (!d.notes || !d.notes.length) { el.innerHTML = '<div class="empty">ÏµúÍ∑º Í∏∞Î°ù ÏóÜÏùå</div>'; return; }
      el.innerHTML = d.notes.map(function(n) {
        return '<div class="hist-item" onclick="openPreview(\'' + n.date + '\')"><div class="hist-date">' + n.date + '</div><div class="hist-preview">' + esc(n.preview) + '</div></div>';
      }).join('');
    })
    .catch(function() { el.innerHTML = '<div class="empty">Î°úÎî© Ïã§Ìå®</div>'; });
}

function filterHist() {
  var q = document.getElementById('hist-search').value.toLowerCase();
  var items = document.querySelectorAll('.hist-item');
  for (var i = 0; i < items.length; i++) {
    items[i].style.display = items[i].textContent.toLowerCase().indexOf(q) >= 0 ? '' : 'none';
  }
}

function openPreview(date) {
  var el = document.getElementById('hist-detail');
  var ov = document.getElementById('hist-overlay');
  api('/daily/' + date)
    .then(function(r) { return r.json(); })
    .then(function(d) { el.innerHTML = renderMd(d.body); ov.style.display = ''; })
    .catch(function() { el.innerHTML = '<div class="empty">Ïò§Î•ò</div>'; ov.style.display = ''; });
}
function closePreview() { document.getElementById('hist-overlay').style.display = 'none'; }

// ---- Settings tab ----
function loadSettings() {
  fetch('/api/health')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      var c = document.getElementById('st-conn');
      c.textContent = d.vault ? 'Ïó∞Í≤∞Îê®' : 'Î≥ºÌä∏ÏóÜÏùå';
      c.className = 'badge ' + (d.vault ? 'ok' : 'err');
      document.getElementById('st-vault').textContent = d.vaultPath || '-';
    })
    .catch(function() {
      var c = document.getElementById('st-conn');
      c.textContent = 'Ïò§ÌîÑÎùºÏù∏'; c.className = 'badge err';
    });
}

// ---- Markdown renderer ----
function renderMd(md) {
  if (!md) return '';
  var h = esc(md);
  h = h.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  h = h.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  h = h.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  h = h.replace(/\*(.+?)\*/g, '<em>$1</em>');
  h = h.replace(/^- (.+)$/gm, '<li>$1</li>');
  h = h.replace(/\n\n+/g, '<br><br>');
  return h;
}

function esc(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ---- Boot ----
if (API_KEY) {
  showApp();
} else {
  document.getElementById('auth').style.display = '';
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="VaultVoice">
<meta name="theme-color" content="#007AFF">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<link rel="stylesheet" href="/app.css">
<title>VaultVoice</title>
</head>
<body>

<!-- Auth -->
<div id="auth" class="screen">
  <div class="auth-box">
    <div style="font-size:48px">🔐</div>
    <h1>VaultVoice</h1>
    <p>API 키를 입력하세요</p>
    <input type="text" id="key-input" class="input" placeholder="API Key" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <br><br>
    <button class="btn" id="auth-btn">연결</button>
    <p id="auth-err" class="err" style="display:none"></p>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  <header><h1 id="hdr">메모</h1></header>

  <!-- Reminder Banner -->
  <div id="reminder-banner" class="reminder-banner" style="display:none">
    <span id="reminder-banner-text"></span>
    <button id="reminder-banner-close" class="reminder-banner-close">&times;</button>
  </div>

  <main>
    <!-- 메모 -->
    <section id="p-memo" class="tab-panel active">
      <div class="date-nav">
        <button class="btn-icon" id="memo-prev">&lsaquo;</button>
        <button id="memo-date" class="date-btn">오늘</button>
        <button class="btn-icon" id="memo-next">&rsaquo;</button>
      </div>
      <div class="form-group">
        <label>섹션</label>
        <div class="chips" id="sec-chips">
          <button class="chip on" data-s="메모">메모</button>
          <button class="chip" data-s="오늘할일">오늘할일</button>
          <button class="chip" data-s="오늘 회고">오늘 회고</button>
        </div>
      </div>

      <!-- Todo options (shown when 오늘할일 selected) -->
      <div id="todo-options" class="form-group" style="display:none">
        <label>우선순위</label>
        <div class="chips" id="priority-chips">
          <button class="chip priority-chip" data-p="높음">🔴 높음</button>
          <button class="chip priority-chip on" data-p="보통">🔵 보통</button>
          <button class="chip priority-chip" data-p="낮음">🟢 낮음</button>
        </div>
        <label style="margin-top:10px">마감일</label>
        <input type="date" id="todo-due" class="input">
      </div>

      <div class="form-group">
        <label>내용</label>
        <div class="memo-input-wrap">
          <textarea id="memo-text" class="input" placeholder="여기를 탭하고 키보드 🎙️ 버튼으로 음성 입력..." rows="6"></textarea>
          <div class="memo-btns">
            <button id="newline-btn" class="memo-tool-btn" title="줄바꿈">↵</button>
            <button id="mic-btn" class="mic-btn" title="음성 인식">🎤</button>
          </div>
        </div>
      </div>

      <!-- Image attachments -->
      <div class="form-group">
        <label>이미지</label>
        <div class="image-attach-row">
          <label class="btn-icon image-pick-btn" title="카메라 촬영">
            📷
            <input type="file" id="image-input" accept="image/*" capture="environment" style="display:none">
          </label>
          <label class="btn-icon image-pick-btn" title="갤러리에서 선택">
            🖼️
            <input type="file" id="gallery-input" accept="image/*" style="display:none">
          </label>
        </div>
        <div id="image-preview" class="image-preview-list"></div>
      </div>

      <!-- Video attachments -->
      <div class="form-group">
        <label>동영상</label>
        <div class="image-attach-row">
          <label class="btn-icon image-pick-btn" title="동영상 촬영">
            🎬
            <input type="file" id="video-input" accept="video/*" capture="environment" style="display:none">
          </label>
          <label class="btn-icon image-pick-btn" title="동영상 선택">
            📁
            <input type="file" id="video-gallery-input" accept="video/*" style="display:none">
          </label>
        </div>
        <div id="video-preview" class="video-preview-list"></div>
      </div>

      <!-- Audio recording -->
      <div class="form-group">
        <label>음성 녹음</label>
        <div class="audio-attach-row">
          <button id="audio-rec-btn" class="btn-icon audio-rec-btn" title="녹음 시작">🎙️</button>
          <span id="audio-rec-status" class="audio-rec-status"></span>
        </div>
        <div id="audio-preview" class="audio-preview-list"></div>
      </div>

      <div class="form-group">
        <label>태그</label>
        <div id="tags-display" class="tag-list"></div>
        <div style="position:relative">
          <input type="text" id="tag-in" class="input" placeholder="태그 추가 (Enter)" autocomplete="off" autocorrect="off" autocapitalize="off">
          <div id="tag-sug" class="suggestions" style="display:none"></div>
        </div>
      </div>
      <button class="btn btn-save" id="save-btn">저장</button>
      <div id="save-fb" class="feedback" style="display:none"></div>
    </section>

    <!-- 오늘 -->
    <section id="p-today" class="tab-panel">
      <div class="date-nav">
        <button class="btn-icon" id="today-prev">&lsaquo;</button>
        <button id="today-date" class="date-btn">오늘</button>
        <button class="btn-icon" id="today-next">&rsaquo;</button>
      </div>
      <!-- AI Buttons -->
      <div id="ai-buttons" class="ai-buttons">
        <button class="btn-sm ai-btn" data-action="summarize">AI 요약</button>
        <button class="btn-sm ai-btn" data-action="suggest-tags">태그 추천</button>
        <button class="btn-sm ai-btn" data-action="categorize">분류</button>
      </div>
      <div id="ai-result" class="ai-result" style="display:none"></div>
      <!-- Todo List -->
      <div id="todo-list-section" style="display:none">
        <h3 class="todo-section-title">할일 목록</h3>
        <div id="todo-list" class="todo-list"></div>
      </div>
      <div id="today-body" class="note-content"><div class="empty">로딩 중...</div></div>
    </section>

    <!-- 기록 -->
    <section id="p-hist" class="tab-panel">
      <div class="search-wrap">
        <input type="text" id="hist-search" class="input search-input" placeholder="검색어 입력 (🎙️ 키보드 마이크)" autocomplete="off" autocorrect="on" spellcheck="false">
        <button id="search-mic-btn" class="search-mic-btn" style="display:none" title="음성 검색">🎤</button>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:6px">
        <button id="search-btn" class="search-go-btn" style="flex:1">검색</button>
        <button id="search-ai-btn" class="search-go-btn" style="flex:1;background:var(--green)">AI 검색</button>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-left:4px">
        <label style="font-size:13px;color:var(--text2);display:flex;align-items:center;gap:4px">
          <input type="checkbox" id="search-all-vault"> 전체 볼트 검색
        </label>
      </div>
      <div id="search-results" style="display:none;margin-bottom:12px"></div>
      <div id="hist-list"><div class="empty">로딩 중...</div></div>
      <div id="hist-overlay" class="overlay" style="display:none">
        <button class="close-btn" id="hist-close">&times;</button>
        <div id="hist-detail" class="note-content"></div>
      </div>
    </section>

    <!-- 설정 -->
    <section id="p-set" class="tab-panel">
      <!-- QR 코드 (아이폰 접속용) -->
      <div class="s-group">
        <h2>QR 코드 (아이폰 스캔)</h2>
        <input type="text" id="qr-url-input" class="input" placeholder="터널 주소 붙여넣기 (https://...trycloudflare.com)" style="margin-bottom:8px;font-size:13px">
        <div id="qr-area" style="text-align:center">
          <img id="qr-img" style="width:180px;height:180px;border-radius:8px;background:#fff;padding:8px" alt="QR">
          <div id="qr-url" style="font-size:11px;color:var(--text2);margin-top:6px;word-break:break-all"></div>
        </div>
      </div>

      <!-- 클립보드 공유 -->
      <div class="s-group">
        <h2>클립보드 공유 (PC ↔ 아이폰)</h2>
        <textarea id="clip-text" class="input" rows="3" placeholder="여기에 텍스트 입력 후 보내기..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn-sm" id="clip-send" style="flex:1">보내기</button>
          <button class="btn-sm" id="clip-recv" style="flex:1;background:var(--green)">받기</button>
        </div>
        <div id="clip-status" style="font-size:12px;color:var(--text2);margin-top:6px;text-align:center"></div>
      </div>

      <!-- 기능 테스트 -->
      <div class="s-group">
        <h2>기능 테스트</h2>
        <button class="btn-sm" id="run-test" style="width:100%;padding:12px;font-size:15px">전체 기능 점검</button>
        <div id="test-results" style="margin-top:10px"></div>
      </div>

      <div class="s-group">
        <h2>서버 연결</h2>
        <div class="s-row"><span>상태</span><span id="st-conn" class="badge">확인중</span></div>
        <div class="s-row" style="border-top:0.5px solid var(--sep);padding-top:10px;margin-top:4px"><span>볼트</span><span id="st-vault" class="s-val">-</span></div>
      </div>
      
      <!-- Phase 3: RAG Knowledge Base -->
      <div class="s-group">
        <h2>지식 베이스 (RAG)</h2>
        <p style="font-size:13px;color:var(--text2);margin-bottom:8px">내 노트 내용을 AI가 이해하도록 학습시킵니다.</p>
        <button class="btn-sm" id="reindex-btn" style="width:100%;padding:12px;font-size:14px;background:var(--purple)">지식 베이스 구축 (최근 50개)</button>
        <div id="reindex-status" style="margin-top:8px;font-size:12px;color:var(--text2)"></div>
      </div>

      <!-- Phase 4: Google Calendar -->
      <div class="s-group">
        <h2>구글 캘린더 연동</h2>
        <p style="font-size:13px;color:var(--text2);margin-bottom:8px">일정 조회 및 추가를 위해 계정을 연결하세요.</p>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <span id="cal-status" class="badge" style="background:var(--bg-card);color:var(--text2)">미연결</span>
          <button class="btn-sm" id="cal-connect-btn" style="padding:8px 16px;font-size:13px">계정 연결</button>
        </div>
        <div id="cal-msg" style="font-size:11px;color:var(--red);display:none"></div>
      </div>

      <div class="s-group">
        <h2>기본 섹션</h2>
        <select id="def-sec" class="input">

          <option value="메모">메모</option>
          <option value="오늘할일">오늘할일</option>
          <option value="오늘 회고">오늘 회고</option>
        </select>
      </div>
      <!-- Reminders list -->
      <div class="s-group">
        <h2>알림 목록</h2>
    <div id="reminder-list" class="reminder-list"><div class="empty">설정된 알림 없음</div></div>
      </div>
      <div class="s-group">
        <button class="btn-danger" id="logout-btn">로그아웃</button>
      </div>
      <div class="ver">VaultVoice v2.0</div>
    </section>
  </main>

  <nav>
    <button class="tab-item active" data-tab="memo"><span class="tab-icon">&#9998;</span><span>메모</span></button>
    <button class="tab-item" data-tab="today"><span class="tab-icon">&#128203;</span><span>오늘</span></button>
    <button class="tab-item" data-tab="hist"><span class="tab-icon">&#128218;</span><span>기록</span></button>
    <button class="tab-item" data-tab="set"><span class="tab-icon">&#9881;</span><span>설정</span></button>
    <a href="/vault" class="tab-item" style="text-decoration:none;color:inherit"><span class="tab-icon">&#129412;</span><span>관리</span></a>
  </nav>
</div>

<!-- Reminder dialog -->
<div id="reminder-dialog" class="reminder-dialog-overlay" style="display:none">
  <div class="reminder-dialog">
    <h3>알림 설정</h3>
    <p id="reminder-dialog-text" style="margin:8px 0;font-size:14px;color:var(--text2)"></p>
    <input type="datetime-local" id="reminder-datetime" class="input" style="margin-bottom:12px">
    <div style="display:flex;gap:8px">
      <button class="btn" id="reminder-save" style="flex:1">설정</button>
      <button class="btn-danger" id="reminder-cancel" style="flex:1">취소</button>
    </div>
  </div>
</div>

<!-- Smart Scan Result Overlay -->
<div id="scan-overlay" class="overlay" style="display:none;z-index:200">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <h2 style="font-size:20px;font-weight:700">스마트 스캔 결과</h2>
    <button class="close-btn" id="scan-close" style="position:static;font-size:24px">&times;</button>
  </div>
  <div id="scan-content" class="note-content" style="margin-bottom:16px">
    <div style="text-align:center;padding:20px;color:var(--text2)">분석 중...</div>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn" id="scan-apply" style="flex:1">메모에 추가</button>
    <button class="btn-danger" id="scan-cancel" style="flex:1;background:var(--bg-card);border:1px solid var(--sep);color:var(--text)">닫기</button>
  </div>
</div>

<!-- Jarvis Chat Overlay -->
<div id="jarvis-overlay" class="jarvis-overlay" style="display:none">
  <div class="jarvis-container">
    <div class="jarvis-header">
      <div class="jarvis-header-left">
        <h2 class="jarvis-title">Jarvis</h2>
        <span id="jarvis-status" class="jarvis-status"></span>
      </div>
      <div class="jarvis-header-right">
        <button id="jarvis-export" class="jarvis-header-btn" title="대화 내보내기">📥</button>
        <button id="jarvis-reset" class="jarvis-header-btn" title="대화 초기화">🗑️</button>
        <button id="jarvis-close" class="jarvis-header-btn" title="닫기">&times;</button>
      </div>
    </div>

    <div id="jarvis-chat" class="jarvis-chat">
      <div class="jarvis-welcome">
        <div class="jarvis-welcome-icon">🤖</div>
        <div class="jarvis-welcome-text">안녕하세요! Jarvis입니다.<br>무엇을 도와드릴까요?</div>
        <div class="jarvis-welcome-hints">
          <button class="jarvis-hint" data-msg="오늘 메모 보여줘">📋 오늘 메모 보기</button>
          <button class="jarvis-hint" data-msg="할일 추가: 보고서 작성">✅ 할일 추가</button>
          <button class="jarvis-hint" data-msg="이번 주 일정 알려줘">📅 이번 주 일정</button>
          <button class="jarvis-hint" data-msg="볼트에서 회의록 검색해줘">🔍 볼트 검색</button>
        </div>
      </div>
    </div>

    <div class="jarvis-input-area">
      <input type="text" id="jarvis-input" class="jarvis-input" placeholder="메시지 입력..." autocomplete="off">
      <button id="jarvis-send" class="jarvis-send-btn" title="전송">➤</button>
      <button id="jarvis-mic" class="jarvis-mic-btn" title="음성 입력">🎙️</button>
    </div>
  </div>
</div>

<script>
// Force SW update on every page load (inline, cache-proof)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistration().then(function(reg) {
    if (reg) reg.update();
  });
}
</script>
<script src="/app.js"></script>
</body>
</html>
